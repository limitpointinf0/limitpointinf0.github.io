<!DOCTYPE HTML>
<html>
	<head>
		<title>NULL Token</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/9.0.1/stellar-sdk.js"></script>
		<script>

			async function getXDR(userAccount, server){

				const customAsset = new StellarSdk.Asset('NULL', 'GCIL22USJAHZMLPUJ2GMBBSQGVH5PWKVUGMVUWCRKRA6Z44DA26HKUK6');
				const fee = await server.fetchBaseFee();
				const txnOpts = {
					fee: fee,
					networkPassphrase: "Test SDF Network ; September 2015"
				};

				const changeTrustOpts = {
					asset: customAsset
				};
				
				const userAccountObj = await server.loadAccount(userAccount);
				const transaction = new StellarSdk.TransactionBuilder(userAccountObj, txnOpts)
					.addOperation(StellarSdk.Operation.changeTrust(changeTrustOpts))
					.setTimeout(0)
					.build();

				return transaction.toEnvelope().toXDR('base64');
			}

			async function getNull() {
				if (window.rabet) {
					console.log('Rabet is installed!');
					rabet.connect()
						.then(result => {

							const userAccount = result.publicKey;
							console.log(`User active public key is: ${userAccount}`);

							const server = new StellarSdk.Server('https://horizon-testnet.stellar.org/');
							
							xdr = getXDR(userAccount, server)
								.then( xdr => {
									const network = 'testnet'; // mainnet / testnet
									rabet.sign(xdr, network)
										.then(result => {
											console.log(`Signed xdr: ${result.xdr}`);
											var envelope = StellarSdk.xdr.TransactionEnvelope.fromXDR(result.xdr, 'base64');
											var transaction = new StellarSdk.Transaction(envelope, StellarSdk.Networks.TESTNET);
											server
												.submitTransaction(transaction)
												.then((result) => {
													console.log(result);
													alert('Congratulations! You have successfully set the trustline. Please wait for the airdrop of NULL.')
												})
												.catch((e) => {
													console.log(e.response.data);
												});
										})
										.catch(error => console.error(`Error: ${error.message}`));
								})
								.catch(error => console.error(`Error: ${error}`));

						})
						.catch(error => console.error(`Error: ${error}`));
				} else {
					console.log('Please install Rabet');
					window.location.replace("https://rabet.io/");
				}
			}
			
		</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
						<div class="logo">
							<span class="icon fa-dot-circle"></span>
						</div>
						<div class="content">
							<div class="inner">
								<h1>Null</h1>
								<p>A token on the Stellar testnet by <a href="http://testnet.stellarchain.io/address/GCIL22USJAHZMLPUJ2GMBBSQGVH5PWKVUGMVUWCRKRA6Z44DA26HKUK6">GCIL22USJAHZMLPUJ2GMBBSQGVH5PWKVUGMVUWCRKRA6Z44DA26HKUK6</a> and released<br />
								with no intrinsic value and no use-case.</p>
							</div>
						</div>
						<nav>
							<ul>
								<li><a href="#about">Get Started!</a></li>
							</ul>
						</nav>
					</header>

				<!-- Main -->
					<div id="main">

						<!-- About -->
							<article id="about">
								<h2 class="major">About</h2>
								<!-- <span><img src="images/qr.png" alt="" /></span> -->
								<p><b>Asset Name:</b> NULL</p>
								<p>NULL token is currently on the Stellar testnet and represents absolutely nothing. To receive this token, you must first install the <a href="https://rabet.io/">Rabet</a> Stellar wallet browser extentions and set a trustline. You will then receive the Airdrop shortly after.</p>
								<button type="button" onclick="getNull();">Set Trustline!</button>
							</article>

					</div>

				<!-- Footer -->
					<footer id="footer">
						<p class="copyright"></a>.</p>
					</footer>

			</div>

		<!-- BG -->
			<div id="bg"></div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>
